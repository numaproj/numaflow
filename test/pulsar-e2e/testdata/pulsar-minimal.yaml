apiVersion: apps/v1
kind: Deployment
metadata:
  name: pulsar-broker
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pulsar-broker
  template:
    metadata:
      labels:
        app: pulsar-broker
    spec:
      containers:
      - name: pulsar
        image: apachepulsar/pulsar:4.0.0
        imagePullPolicy: IfNotPresent
        command:
        - /bin/bash
        - -c
        - |
          set -euo pipefail
          # The secret key and JWT token used here were generated by: https://pulsar.apache.org/docs/4.0.x/security-jwt/
          echo 'awXCCTURDUXW1FE5wrfuHO8kr6cuoa2ZrqVG5qCQuac=' | base64 -d > /pulsar/conf/secret.key
          export TOKEN="eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ0ZXN0LXVzZXIifQ.fDSXQNpGAYCxjsuBVsH4S3eK9YYtzpz8_vAYqLpTp2o"
          chown pulsar /pulsar/conf/secret.key
          sed -i 's|tokenSecretKey=|tokenSecretKey=file:///pulsar/conf/secret.key|' /pulsar/conf/standalone.conf
          sed -i 's|authenticationEnabled=false|authenticationEnabled=true|' /pulsar/conf/standalone.conf
          sed -i 's|authenticationProviders=|authenticationProviders=org.apache.pulsar.broker.authentication.AuthenticationProviderToken|' /pulsar/conf/standalone.conf
          sed -i 's|brokerClientAuthenticationPlugin=|brokerClientAuthenticationPlugin=org.apache.pulsar.client.impl.auth.AuthenticationToken|' /pulsar/conf/standalone.conf
          sed -i "s|brokerClientAuthenticationParameters=|brokerClientAuthenticationParameters={\"token\":\"$TOKEN\"}|" /pulsar/conf/standalone.conf
          /pulsar/bin/pulsar standalone

        ports:
        - containerPort: 6650
        - containerPort: 8080

---
apiVersion: v1
kind: Service
metadata:
  name: pulsar-service
spec:
  selector:
    app: pulsar-broker
  ports:
  - name: pulsar-broker
    protocol: TCP
    port: 6650
    targetPort: 6650
  - name: pulsar-web
    protocol: TCP
    port: 8080
    targetPort: 8080
  type: ClusterIP

---
apiVersion: v1
kind: Secret
metadata:
  name: pulsar-source-e2e
type: Opaque
data:
  token: ZXlKaGJHY2lPaUpJVXpJMU5pSjkuZXlKemRXSWlPaUowWlhOMExYVnpaWElpZlEuZkRTWFFOcEdBWUN4anN1QlZzSDRTM2VLOVlZdHpwejhfdkFZcUxwVHAybwo=
